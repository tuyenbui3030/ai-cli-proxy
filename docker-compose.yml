services:
  cli-proxy-api:
    image: eceasy/cli-proxy-api:latest
    container_name: cli-proxy-api
    restart: always
    ports:
      - "${PORT:-8317}:8317"
    volumes:
      - ./config.yaml:/CLIProxyAPI/config.yaml
      - ./auth:/root/.cli-proxy-api
    environment:
      - TZ=${TZ:-Asia/Ho_Chi_Minh}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8317/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Backup service - exports data every BACKUP_INTERVAL minutes
  backup:
    image: alpine:latest
    container_name: cli-proxy-backup
    restart: always
    depends_on:
      cli-proxy-api:
        condition: service_healthy
    volumes:
      - ./backups:/backups
    environment:
      - TZ=${TZ:-Asia/Ho_Chi_Minh}
      - API_URL=${API_URL:-http://cli-proxy-api:8317}
      - API_TOKEN=${API_TOKEN:-your-key-here}
      - BACKUP_INTERVAL=${BACKUP_INTERVAL:-5}
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-10}
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache curl
        echo "Starting backup service (interval: $${BACKUP_INTERVAL}m, retention: $${BACKUP_RETENTION_DAYS} days)"
        while true; do
          TIMESTAMP=$$(date +%Y%m%d_%H%M%S)
          TEMP_FILE="/tmp/usage-$${TIMESTAMP}.json"
          # Export to temp file first
          curl -s -o "$${TEMP_FILE}" \
            -H "Authorization: Bearer $${API_TOKEN}" \
            "$${API_URL}/v0/management/usage/export"
          # Check if export has valid data (total_requests > 0)
          TOTAL_REQUESTS=$$(grep -o '"total_requests":[0-9]*' "$${TEMP_FILE}" | head -1 | cut -d: -f2)
          if [ -n "$$TOTAL_REQUESTS" ] && [ "$$TOTAL_REQUESTS" -gt 0 ]; then
            # Valid data - save timestamped and update latest
            mv "$${TEMP_FILE}" /backups/usage-$${TIMESTAMP}.json
            cp /backups/usage-$${TIMESTAMP}.json /backups/usage-latest.json
            echo "$$(date): Backup saved to usage-$${TIMESTAMP}.json ($$TOTAL_REQUESTS requests)"
          else
            # Empty data - skip updating latest
            rm -f "$${TEMP_FILE}"
            echo "$$(date): Skipped backup - no data (total_requests=$$TOTAL_REQUESTS)"
          fi
          # Cleanup old backups (keep last N days)
          find /backups -name "usage-*.json" -type f -mtime +$${BACKUP_RETENTION_DAYS} ! -name "usage-latest.json" -delete
          sleep $$((BACKUP_INTERVAL * 60))
        done

  # Restore service - imports data when container starts
  restore:
    image: alpine:latest
    container_name: cli-proxy-restore
    restart: "no"
    depends_on:
      cli-proxy-api:
        condition: service_healthy
    volumes:
      - ./backups:/backups
    environment:
      - TZ=${TZ:-Asia/Ho_Chi_Minh}
      - API_URL=${API_URL:-http://cli-proxy-api:8317}
      - API_TOKEN=${API_TOKEN:-afternoon-curry-silly-eraser-dimness-turbine}
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache curl
        if [ -f /backups/usage-latest.json ]; then
          echo "Restoring data from backup..."
          HTTP_CODE=$$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $${API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d @/backups/usage-latest.json \
            "$${API_URL}/v0/management/usage/import")
          if [ "$$HTTP_CODE" = "200" ]; then
            echo "$$(date): Restore successful"
          else
            echo "$$(date): Restore failed with HTTP $$HTTP_CODE"
          fi
        else
          echo "No backup file found, skipping restore"
        fi
